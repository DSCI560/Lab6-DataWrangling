<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Oil Wells Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map { height: 100%; margin: 0; padding: 0; }
    .popup-table { border-collapse: collapse; width: 100%; }
    .popup-table td, .popup-table th { border: 1px solid #ddd; padding: 4px; font-size: 12px; }
    .popup-title { font-weight: bold; margin-bottom: 6px; display:block; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    var map = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    function fetchWells() {
      return fetch('/api/wells').then(function(r){ return r.json(); });
    }

    function makePopupHtml(w) {
      var html = '';
      html += '<div><span class="popup-title">' + (w.well_name || 'No name') + '</span></div>';
      html += '<table class="popup-table">';
      html += '<tr><th>API</th><td>' + (w.api || '') + '</td></tr>';
      html += '<tr><th>Well #</th><td>' + (w.well_number || '') + '</td></tr>';
      html += '<tr><th>Operator</th><td>' + (w.operator || '') + '</td></tr>';
      html += '<tr><th>County</th><td>' + (w.county || '') + '</td></tr>';
      html += '<tr><th>State</th><td>' + (w.state || '') + '</td></tr>';
      html += '<tr><th>QC Status</th><td>' + (w.qc_status || '') + '</td></tr>';
      html += '</table>';
      if (w.stimulations && w.stimulations.length) {
        html += '<div style="margin-top:6px;font-weight:bold">Stimulations</div>';
        html += '<table class="popup-table">';
        html += '<tr><th>Date</th><th>Formation</th><th>Stages</th><th>Volume</th><th>Proppant(lbs)</th></tr>';
        w.stimulations.forEach(function(s){
          html += '<tr>';
          html += '<td>' + (s.date_stimulated || '') + '</td>';
          html += '<td>' + (s.stimulated_formation || '') + '</td>';
          html += '<td>' + (s.stages || '') + '</td>';
          html += '<td>' + (s.volume || '') + ' ' + (s.volume_units || '') + '</td>';
          html += '<td>' + (s.lbs_proppant || '') + '</td>';
          html += '</tr>';
        });
        html += '</table>';
      }
      return html;
    }

    fetchWells().then(function(list){
      list.forEach(function(w){
        if (w.latitude && w.longitude) {
          var marker = L.marker([w.latitude, w.longitude]).addTo(map);
          marker.bindPopup(makePopupHtml(w));
        }
      });
    });
  </script>
</body>
</html>